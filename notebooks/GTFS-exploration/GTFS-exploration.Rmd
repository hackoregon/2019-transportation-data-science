---
title: "GTFS Exploration"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r}
library(tidyverse)
library(tidytransit)


```

## Acquire latest TriMet GTFS
```{r}
trimet_gtfs <- tidytransit::read_gtfs(
  path = "https://developer.trimet.org/schedule/gtfs.zip",
  local = FALSE,
  quiet = FALSE,
  geometry = TRUE)
gc(reset = TRUE)

summary(trimet_gtfs)

```

## Service patterns
```{r}
trimet_gtfs <- trimet_gtfs %>% tidytransit::set_hms_times()
gc(reset = TRUE)
trimet_gtfs <- trimet_gtfs %>% tidytransit::set_date_service_table()
gc(reset = TRUE)
holidays <- tibble::tribble(
  ~date, ~holiday,
  lubridate::ymd("2019-09-02"), "Labor Day",
  lubridate::ymd("2019-11-28"), "Thanksgiving"
)
calendar = tibble::tibble(date = unique(trimet_gtfs$.$date_service_table$date)) %>% 
  dplyr::mutate(
    weekday = (function(date) {
      c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday",
        "Saturday")[as.POSIXlt(date)$wday + 1]
    })(date)
  )
calendar <- calendar %>% dplyr::left_join(holidays, by = "date")

trimet_gtfs <- trimet_gtfs %>% tidytransit::set_servicepattern()
n_services <-  length(unique(trimet_gtfs$trips$service_id))
n_servicepatterns <- length(unique(trimet_gtfs$.$service_pattern$servicepattern_id))

date_servicepattern_table <- trimet_gtfs$.$date_servicepattern_table %>%
  dplyr::left_join(calendar, by = "date")

ggplot(date_servicepattern_table) + theme_bw() + 
  geom_point(aes(x = date, y = servicepattern_id, color = weekday), size = 1) +
  scale_x_date(breaks = scales::date_breaks("1 month")) +
  theme(legend.position = "bottom")

```

