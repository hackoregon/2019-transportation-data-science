---
title: "Stop-to-stop Analysis"
output: html_notebook
---

## Libraries
```{r}
library(data.table)
library(lubridate)
library(sf)
library(janitor)

```

## Functions
```{r}
## quarter hour of day
qhod <- function(tstamp) {
  0.25 * trunc(4 * hour(tstamp) + minute(tstamp) / 15)
}

```

## Load stop events CSV
Note: because this has to run in an 8GB laptop, we garbage-collect frequently and avoid chaining
/ pipes.
```{r}
passenger_stop_events <- fread("/csvs/raw_stop_event_2017_09.csv")
gc()
passenger_stop_events <- passenger_stop_events[
  VEHICLE_NUMBER > 0 & ROUTE_NUMBER > 0 & ROUTE_NUMBER <= 291 &
  TRIP_NUMBER > 0 & TRAIN > 0 & LOCATION_ID > 0
]
gc()
```

## Stop location GIS computations
```{r}
# make the stop location table
stop_locations <- passenger_stop_events[
  , .(X_COORDINATE_2913 = median(X_COORDINATE), Y_COORDINATE_2913 = median(Y_COORDINATE)),
  by = "LOCATION_ID"
]
gc()
coords_4326 <- st_coordinates(st_transform(st_sfc(st_multipoint(as.matrix(stop_locations[
    , X_COORDINATE_2913:Y_COORDINATE_2913])), crs = 2913), 4326))
coords_4326 <- as.data.table(coords_4326[, 1:2])
names(coords_4326) <- c("GPS_LONGITUDE_4326", "GPS_LATITUDE_4326")
stop_locations <- cbind(stop_locations, coords_4326)
gc()

# tag the stop event table
passenger_stop_events <- merge(passenger_stop_events, stop_locations, by = "LOCATION_ID")
gc()
passenger_stop_events <- passenger_stop_events[, !(X_COORDINATE:Y_COORDINATE)]
gc()

```

## Date computations
```{r}
passenger_stop_events <- passenger_stop_events[
  , SERVICE_DATE := fast_strptime(
    SERVICE_DATE, format = "%d%b%Y:%H:%M:%S", tz = "PST8PDT", lt = FALSE
  )
]
gc()
passenger_stop_events <- passenger_stop_events[
  , `:=`(
    STOP_TIME = SERVICE_DATE + STOP_TIME,
    ARRIVE_TIME = SERVICE_DATE + ARRIVE_TIME,
    LEAVE_TIME = SERVICE_DATE + LEAVE_TIME,
    YEAR = year(SERVICE_DATE),
    MONTH = month(SERVICE_DATE),
    DAY = mday(SERVICE_DATE),
    DAY_OF_WEEK = wday(SERVICE_DATE)
  )
]
gc()
passenger_stop_events <- passenger_stop_events[
  , QHOUR_OF_DAY := qhod(ARRIVE_TIME)
]
gc()

```

## Compute lagged columns
```{r}
# sort the stop events table by trips
setkeyv(passenger_stop_events, c( 
       "SERVICE_DATE", "VEHICLE_NUMBER", "TRAIN", "ROUTE_NUMBER", "DIRECTION",
       "SERVICE_KEY", "TRIP_NUMBER", "ARRIVE_TIME", "LEAVE_TIME"), verbose = TRUE)
gc()
passenger_stop_events <- passenger_stop_events[
  , `:=`(
    FROM_LOCATION_ID = shift(LOCATION_ID),
    FROM_LEAVE_TIME = shift(LEAVE_TIME),
    FROM_STOP_TIME = shift(STOP_TIME),
    FROM_ARRIVE_TIME = shift(ARRIVE_TIME),
    FROM_ONS = shift(ONS),
    FROM_OFFS = shift(OFFS),
    FROM_ESTIMATED_LOAD = shift(ESTIMATED_LOAD),
    FROM_TRAIN_MILEAGE = shift(TRAIN_MILEAGE)
  ),
  by = c("SERVICE_DATE", "VEHICLE_NUMBER", "TRAIN", "ROUTE_NUMBER", "DIRECTION",
         "SERVICE_KEY", "TRIP_NUMBER")
]
gc()

```

## Save output CSV file
```{r}
names(passenger_stop_events) <- make_clean_names(names(passenger_stop_events))
fwrite(passenger_stop_events, file = "/csvs/passenger_stop_events_2017_09.csv",
       verbose = TRUE)
gc()

```

