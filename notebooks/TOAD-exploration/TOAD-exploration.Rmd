---
title: "TOAD data exploration"
output: html_notebook
---

## Libraries
```{r}
library(data.table)

```

## Functions
```{r}
## quarter hour of day
qhod <- function(tstamp) {
  0.25 * trunc(4 * hour(tstamp) + minute(tstamp) / 15)
}

# five-number summary
quantiles <- function(x) {
  list(c(
    length(x),
    quantile(
      x, probs = c(0.05, 0.25, 0.50, 0.75, 0.95), na.rm = TRUE, names = FALSE
    )
  ))
}

```

## Vehicle stop history
Note: because this has to run in an 8GB laptop, we garbage-collect frequently
and avoid chaining / pipes.
```{r}
vehicle_stop_history <- fread("/csvs/raw_veh_stoph_2017_09.csv")
gc()

```

## Stop events
```{r}
stop_events <- fread("/csvs/raw_stop_event_2017_09.csv")
gc()

```

## Join the tables to get bus passenger stops
```{r}
vehicle_stop_history_by <- c(
  "OPD_DATE",
  "VEHICLE_ID",
  "ACT_ARR_TIME",
  "ACT_DEP_TIME",
  "STOP_ID"
)
setkeyv(vehicle_stop_history, vehicle_stop_history_by)
gc()
stop_events_by <- c(
  "SERVICE_DATE",
  "VEHICLE_NUMBER",
  "ARRIVE_TIME",
  "LEAVE_TIME",
  "LOCATION_ID"
)
setkeyv(stop_events, stop_events_by)
gc()
vehicle_stop_history <- merge(
  vehicle_stop_history, stop_events,
  by.x = vehicle_stop_history_by, by.y = stop_events_by,
  all = FALSE
)
rm(stop_events, stop_events_by)
gc()

```

## Date computations
```{r}
vehicle_stop_history <- vehicle_stop_history[
  , OPD_DATE := as.POSIXct(strptime(
    OPD_DATE, format = "%d%b%Y:%H:%M:%S", tz = "PST8PDT"
  ))
]
gc()
vehicle_stop_history <- vehicle_stop_history[
  , `:=`(
    NOM_ARR_TIME = OPD_DATE + NOM_ARR_TIME,
    ACT_ARR_TIME = OPD_DATE + ACT_ARR_TIME,
    NOM_DEP_TIME = OPD_DATE + NOM_DEP_TIME,
    ACT_DEP_TIME = OPD_DATE + ACT_DEP_TIME,
    YEAR = year(OPD_DATE),
    MONTH = month(OPD_DATE),
    DAY = mday(OPD_DATE),
    DAY_OF_WEEK = wday(OPD_DATE)
  )
]
gc()
vehicle_stop_history <- vehicle_stop_history[
  , QHOUR_OF_DAY := qhod(ACT_ARR_TIME)
]
gc()

```

## Lagged columns
```{r}
vehicle_stop_history_by <- c(
  "VEHICLE_ID",
  "ACT_ARR_TIME",
  "ACT_DEP_TIME",
  "STOP_ID"
)
setkeyv(vehicle_stop_history, vehicle_stop_history_by)
vehicle_stop_history <- vehicle_stop_history[
  , `:=`(
    FROM_STOP = shift(STOP_ID),
    METERS_TRAVELED = METERS - shift(METERS),
    SECONDS_TRAVELED = as.integer(ACT_ARR_TIME - shift(ACT_DEP_TIME)),
    ARRIVING_LOAD = shift(ESTIMATED_LOAD),
    SECONDS_LATE = as.integer(ACT_ARR_TIME - NOM_ARR_TIME)
  ),
  by = EVENT_NO_TRIP
]
gc()

```
## Primitive summary
```{r}
primitive_summary <- vehicle_stop_history[
  !is.na(FROM_STOP),
  .(QUANTILES = quantiles(SECONDS_TRAVELED)),
  by = .(FROM_STOP, STOP_ID)
]
gc()

```

