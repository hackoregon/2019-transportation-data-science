---
title: "Loading the TriMet Congestion Data"
output: html_notebook
---

## Function definitions

### Load a "trimet_stop_event" CSV file
```{r}
#' load_csv
#'
#' @param path path to a TriMet "trimet_stop_event" CSV file
#'
#' @return a tibble with the data from the file
load_csv <- function(path) {
  temp <- read_csv(
    path,
    col_types = cols(
      SERVICE_DATE = col_date(format = "%d%b%Y:%H:%M:%S"),
      VEHICLE_NUMBER = col_integer(),
      PATTERN_DISTANCE = col_double()
    )
  )
  temp$SERVICE_DATE <- as.character(temp$SERVICE_DATE)
  return(temp)
}
```

### Drop unused columns
```{r}
#' drop_unused_columns
#'
#' @param stop_events a stop_events tibble
#'
#' @return the tibble minus unused columns
drop_unused_columns <- function(stop_events) {

  temp <- stop_events %>% select(
    -BADGE,
    -MAXIMUM_SPEED,
    -TRAIN_MILEAGE,
    -PATTERN_DISTANCE,
    -LOCATION_DISTANCE,
    -X_COORDINATE,
    -Y_COORDINATE,
    -DATA_SOURCE,
    -SCHEDULE_STATUS
  )
  return(temp)
}
```

### Filter unwanted rows
```{r}
#' filter_unwanted_rows
#'
#' @param stop_events a stop_events tibble
#'
#' @return the tibble minus unwanted rows
filter_unwanted_rows <- function(stop_events) {
  temp <- stop_events %>% filter(
    LOCATION_ID > 0,
    ROUTE_NUMBER > 0,
    ROUTE_NUMBER <= 291,
    SERVICE_KEY == "W" |
      SERVICE_KEY == "S" |
      SERVICE_KEY == "U" |
      SERVICE_KEY == "X"
  )
  return(temp)
}
```

### Group by trips
```{r}

#' group_by_trips
#'
#' @param stop_events a "stop events" tibble
#'
#' @return the tibble grouped by trips
group_by_trips <- function(stop_events) {

  # sort first to get each trip in chronological order
  temp <- stop_events %>% arrange(
    VEHICLE_NUMBER,
    SERVICE_DATE,
    ARRIVE_TIME
  ) %>%
    group_by(
      SERVICE_DATE,
      VEHICLE_NUMBER,
      ROUTE_NUMBER,
      DIRECTION,
      TRIP_NUMBER
    )
  return(temp)
}
```

### Compute lagged columns
```{r}
#' compute_lagged_columns
#' Once we have the data grouped by trips, we add a column for the
#' previous location ID and the time the vehicle left there.
#' Then we compute the travel time.
#'
#' @param stop_events a stop_events tibble
#'
#' @return the tibble with the new columns
compute_lagged_columns <- function(stop_events) {
  temp <- stop_events %>%
    mutate(
      SECONDS_LATE = ARRIVE_TIME - STOP_TIME,
      FROM_LOCATION = lag(LOCATION_ID),
      LEFT_THERE = lag(LEAVE_TIME),
      TRAVEL_SECONDS = ARRIVE_TIME - LEFT_THERE
   ) %>%
   filter(
     !is.na(TRAVEL_SECONDS),
     TRAVEL_SECONDS > 0
   )
  return(temp)
}
```

### Select output columns
```{r}
#' select_output_columns
#'
#' @param stop_events a stop_events tibble
#'
#' @return the selected columns
select_output_columns <- function(stop_events) {
  temp <- stop_events %>% select(
    SERVICE_DATE,
    VEHICLE_NUMBER,
    ROUTE_NUMBER,
    DIRECTION,
    TRIP_NUMBER,
    SERVICE_KEY,
    STOP_TIME,
    ARRIVE_TIME,
    SECONDS_LATE,
    LEAVE_TIME,
    DWELL,
    LOCATION_ID,
    DOOR,
    LIFT,
    ONS,
    OFFS,
    ESTIMATED_LOAD,
    FROM_LOCATION,
    LEFT_THERE,
    TRAVEL_SECONDS
  ) %>%
  ungroup()
  return(temp)
}
```

## Define the month table
Many of our machines don't have enough RAM to deal with the whole dataset. It turns out there are no dependencies between the months so we can easily process one month at a time.
```{r}
month_table <- tibble::tribble(
  ~table_prefix, ~input_file,
  "m2017_09", "trimet_stop_event 1-30SEP2017.csv",
  "m2017_10", "trimet_stop_event 1-31OCT2017.csv",
  "m2017_11", "trimet_stop_event 1-30NOV2017.csv"
)
```

## Main program
Load libraries and force project root directory
```{r}
if (!require(tidyverse)) install.packages("tidyverse")
library(tidyverse)
setwd("/d/Projects/transportation-congestion-analysis")
```

### Main loop - read a file, run the processing pipeling, save as CSV
```{r}
for (i in 1:nrow(month_table)) {

  gc(full = TRUE, verbose = TRUE)
  trimet_stop_events <- load_csv(
    paste("data/raw", month_table$input_file[i], sep = "/")
  )
  gc(full = TRUE, verbose = TRUE)

  trimet_stop_events <- trimet_stop_events %>%
    drop_unused_columns()
  gc(full = TRUE, verbose = TRUE)

  trimet_stop_events <- trimet_stop_events %>%
    filter_unwanted_rows()
  gc(full = TRUE, verbose = TRUE)

  trimet_stop_events <- trimet_stop_events %>%
    group_by_trips()
  gc(full = TRUE, verbose = TRUE)

  trimet_stop_events <- trimet_stop_events %>%
    compute_lagged_columns()
  gc(full = TRUE, verbose = TRUE)

  trimet_stop_events <- trimet_stop_events %>%
    select_output_columns()
  gc(full = TRUE, verbose = TRUE)

  colnames(trimet_stop_events) <- tolower(colnames(trimet_stop_events))
  trimet_stop_events %>% write_csv(path = paste(
    "data/interim",
    paste(
      month_table$table_prefix[i],
      "trimet_stop_events.csv",
      sep = "_"
    ),
    sep = "/"
  ))
  gc(full = TRUE, verbose = TRUE)
}
```
